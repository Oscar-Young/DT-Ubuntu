#!/bin/bash
echo -e "CDT 20.08\n"

# Dev
DT_HOME=$DT_HOME
WEB_PORT=$WEB_PORT
WEB_HOST=$WEB_HOST
WEB_URL=$WEB_HOST:$WEB_PORT

[ "$#" != 1 ] && echo 'dt [sysinfo | sysprep | build | list | restart]' && exit 1
c="sysinfo sysprep build list restart"
[[ ! "${c}" =~ "$1" ]] && echo "Oops, wrong command" && exit 1

i=$(cat /etc/hosts | grep -E "mas|wka" | tr '\t' ' ' | cut -d' ' -f1)
c=$1

ps aux | grep -v grep | grep -o 'busybox httpd' &>/dev/null
[ "$?" != "0" ] && echo -e "Start Web Server at : $WEB_URL" && busybox httpd -p 8888 -h $DT_HOME/web || echo "Web Server is already start : $WEB_URL"

case $c in
sysinfo)
  for x in $i
  do
    nc -w 2 -z $x 22
    [ "$?" != "0" ] && continue
    ssh $x "wget -qO - $WEB_URL/script/sysinfo | bash"
  done
  ;;
sysprep)
  for x in $i
  do
    nc -w 2 -z $x 22 &>/dev/null
    [ "$?" != "0" ] && continue
    ssh $x "wget -qO - $WEB_URL/script/sysprep | bash"
    echo ""
  done
  ;;
build)
  for x in $i
  do
    nc -w 2 -z $x 22
    [ "$?" != "0" ] && continue
    [ ! -f "$DT_HOME/web/stack/hadoop-2.10.1.alpine.tar.gz" ] && echo "Hadoop Not found"
    [ ! -f "$DT_HOME/web/stack/pig-0.17.0.tar.gz" ] &&  echo "download Aapche pig-0.17.0..." && wget -q 'ftp://ftp.twaren.net/Unix/Web/apache/pig/pig-0.17.0/pig-0.17.0.tar.gz' -O $DT_HOME/web/stack/pig-0.17.0.tar.gz  
    [ ! -f "$DT_HOME/web/stack/apache-hive-2.3.7-bin.tar.gz" ] &&  echo "download Aapche hive-2.3.7..." && wget -q 'ftp://ftp.twaren.net/Unix/Web/apache/hive/hive-2.3.7/apache-hive-2.3.7-bin.tar.gz' -O $DT_HOME/web/stack/apache-hive-2.3.7-bin.tar.gz  
    [ ! -f "$DT_HOME/web/stack/apache-tez-0.9.2-bin.tar.gz" ] &&  echo "download Aapche tez-0.9.2..." && wget -q 'ftp://ftp.twaren.net/Unix/Web/apache/tez/0.9.2/apache-tez-0.9.2-bin.tar.gz' -O $DT_HOME/web/stack/apache-tez-0.9.2-bin.tar.gz  
    ssh $x "wget -qO - $WEB_URL/script/build | bash"
  done
  ;;
list)
  ;;
restart)
  read -p "Are you sure ? (YES/NO) " ans
  [ $ans != "YES" ] && exit 1
  for x in $i
  do
    nc -w 2 -z $x 22 &>/dev/null
    [ "$?" != "0" ] && continue
    ssh $x 'sudo reboot' 
  done
  ;;
esac
